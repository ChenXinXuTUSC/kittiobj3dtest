# 框架目的

## DDP 分布式训练

```txt
Trainer.run():
    # mp.spawn into ddp mode
        ddp_entry():
            ddp_setup()
            train()
            ddp_cleanup()
```

## 包装方式

主要来说框架通过读取配置文件中，相应组件的字符串名称，然后去注册表里面通过该名称拿对应的类型构造函数，构造完所有的组件之后，开始并行分布式训练。

# 主要结构

```txt
## Model 模型
    存放相关的模型代码
## Dataset 数据集
    数据集适配代码，用户必须知道自己实现的数据集代码和哪些模型要求的输入是匹配的
## Metric 评估指标
    训练过程中模型调用的评估指标，模型将所有输出作为依赖参数传递给评估指标函数，在这里负责一些日志的记录，比如 TensorBoard 的可视化图像日志记录
## LOSS 损失函数
    用户必须知道实现的某个损失函数，需要配合哪些模型代码来运行
## Conf 配置文件
    指定一次运行时，配套的 【模型】+【数据集】+【评估指标】+【损失函数】
```

# 踩坑

## 多进程全局日志器的创建
> 但不幸的是，如果提前创建好日志器，比如使用了 `logging.logger` 等模块，那么日志器对象会持有对日志文件的锁，而持有锁的对象是无法在 `mp.spawn` 生成多进程组的时候序列化为对象传递给子进程的，因此我不得不将日志器的创建放在每个子进程被初始化之后，每个进程判断自己是否需要创建日志器（通过判断 `rank` 来实现）。

```python
if self.world_rank == 0:
    self.loggertfx = utils.logger.LoggerTXTFX(
        self.log_alldir, name=self.log_exname
    )
else:
    self.loggertfx = None
```

只有主进程才拥有日志器。

## mp.spawn 不接受双下划线的属性

我就是有很多奇怪的想法突然想尝试，想学别人那些库，把不想给外界访问的方法用双下划线装饰，结果 `mp.spawn` 也不能访问被双下划线修饰的函数……
